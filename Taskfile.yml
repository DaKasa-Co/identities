version: '3'

tasks:
  build-images:
    cmds:
      - docker build . -t identities:0.1.0
      - docker build . -f Dockerfile.database -t database:latest

  test:all:
    dir: functional_tests
    cmds:
      - go test ../...
      - docker-compose up -d 
      - sleep 7
      - cmd: go run test.go
        ignore_error: true
      - docker-compose down
    env:
      DB_NAME: identities
      DB_USER: postgres
      DB_HOST: localhost
      DB_PASSWORD: someAwesomePassword

  test:unit:
    cmds:
      - go test ./...

  test:functional:
    dir: functional_tests
    cmds:
      - docker-compose up -d 
      - sleep 7
      - cmd: go run test.go
        ignore_error: true
      - docker-compose down
    env:
      DB_NAME: identities
      DB_USER: postgres
      DB_HOST: localhost
      DB_PASSWORD: someAwesomePassword

  up-k8s:
    cmds:
      - helm install identities chart/microsservices

  up:
    dir: functional_tests
    cmds:
      - docker-compose up

  down:
    dir: functional_tests
    cmds:
      - docker-compose down

  down-k8s:
    cmds:
      - helm uninstall identities
  
  gen-docs-by-spec:
    dir: docs
    cmds:
      - swagger generate markdown
      - swagger generate server
